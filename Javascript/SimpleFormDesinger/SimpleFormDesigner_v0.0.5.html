<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

	<head>
		<title>IT Tech Office - Simple Form Designer v0.0.5</title>
		<style>

            /* For Selectable */
            #drawingPanel .ui-selecting { 
                background: #707070 ;            
            }

            #drawingPanel .ui-selected { 
                background: #EEEEEE; color: #000000; 
            }
            
            /* disable the text selection */
			#drawingPanel div, #elementList {
				-webkit-touch-callout: none; /* iOS Safari */
				-webkit-user-select: none;   /* Chrome/Safari/Opera */
				-khtml-user-select: none;    /* Konqueror */
				-moz-user-select: none;      /* Firefox */
				-ms-user-select: none;       /* Internet Explorer/Edge */
				user-select: none;           /* Non-prefixed version, currently not supported by any browser */
				cursor:default;
                display: block;
			}

            /* For drawing Panel */

            #drawingPanel{
                display: block;
            }

            /* for hbox and vbox*/            
            #drawingPanel .hbox div{
                display: inline-block;
            }

            #drawingPanel .vbox div{
                display: block;
            }

            #drawingPanel div.vbox, #drawingPanel div.hbox {
                margin: 5px;
                padding: 5px;
                border: 1px dashed;
            }
            
            /* for table in drawingPanel */
            #drawingPanel table td {
                padding: 5px;
                border: 1px dashed;
            }

            #drawingPanel td div{
                display: inline-block;
            }
            
            /* for controls */
            #drawingPanel .control-container div{
                display: inline-block;
            }

            #drawingPanel .control-container {
                width: 100px
            }

            /* handle */
            #drawingPanel .handle {
                width: 20px;
                height: 20px;
                background: gray;
                display: inline-block;
            }

		</style>
        <!-- Jquery Core -->
		<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <!-- Jquery UI -->
		<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
		
        <!-- vkbeautify (for pretty print)-->
        <script src="http://www.eslinstructor.net/vkbeautify/vkbeautify.js"></script>
        
        <script>
			$( function() {

                controlHelper = {
                      labelHelper : function(controlTyle, control){
                        var meta = {type: "", id: "", value: ""};
                        var controlId;
                        var controlValue;
                        
                        // type
                        meta.type = controlTyle;

                        // id
                        controlId = control.id;
                        meta.id = controlId;

                        // value
                        jControl = $(control);
                        controlValue = jControl.find(".control-content")[0].innerText;
                        meta.value = controlValue;

                        return meta;
                    },

                    getMeta : function(control) {
                        var controlType;
                        var classList = control.classList; 
                        for (var i=0; i<classList.length; i++){
                            var className = classList[i];
                            if (className.includes("control-type")){
                                controlType = className.replace("control-type-", "");
                                break;
                            }
                        }
                        debugger;
                        if (controlType == 'label'){
                            return this.labelHelper('label', control);
                        }
                        return null;
                    }
                };
                
                //  
                refresh = function refresh(){
                    $("#drawingPanel").sortable({
                        containment: "#drawingPanelContainer",
                        handle: ".handle",
                        connectWith: "#drawingPanel, #drawingPanel td, #drawingPanel div.vbox, #drawingPanel div.hbox"
                    }).selectable({
                        cancel: ".handle",
                        selected: function(event, ui){
                            var meta = controlHelper.getMeta(ui.selected);
                            if (meta){
                                $("#controlId").val(meta.id);
                                $("#controlType").val(meta.type);
                                $("#controlValue").val(meta.value)
                            }
                        }
                    });
                    $("#drawingPanel td").sortable({
                        containment: "#drawingPanelContainer",
                        connectWith: "#drawingPanel, #drawingPanel td, #drawingPanel div.vbox, #drawingPanel div.hbox"
                    });
                    $("#drawingPanel div.vbox").sortable({
                        containment: "#drawingPanelContainer",
                        connectWith: "#drawingPanel, #drawingPanel td, #drawingPanel div.vbox, #drawingPanel div.hbox"
                    });
                    $("#drawingPanel div.hbox").sortable({
                        containment: "#drawingPanelContainer",
                        connectWith: "drawingPanel, #drawingPanel td, #drawingPanel div.vbox, #drawingPanel div.hbox"
                    });
                };

				drawingPanel = $("#drawingPanel");
				// define id sequence for drawPanel
				drawingPanel.idCount = 0;
				drawingPanel.getNextId = function(){
					this.idCount = this.idCount + 1;
					return "drawingPanelItem" + this.idCount;
				};
                refresh();
                
                $("#updateDrawingBtn").click(function(){
                    var meta = {id:"", type: "", value: ""};
                    var control;
                    meta.id = $("#controlId").val()
                    meta.type = $("#controlType").val();
                    meta.value = $("#controlValue").val();
                    control = $("#"+meta.id);
                    if (meta.type=="label"){
                        var controlContent = control.find(".control-content");
                        controlContent[0].innerText = meta.value;
                    }
                });

                $("#generateBtn").click(function(){ 
					$("#drawingPanelMeta").val("ID Count: " + drawingPanel.idCount);
                    var drawingPanelGenForm = drawingPanel.clone();
                    drawingPanelGenForm.removeClass("ui-sortable");
                    drawingPanelGenForm.find(".ui-sortable").each(function(index, value){
                        var jvalue = $(value)
                        jvalue.removeClass("ui-sortable");
                        if (jvalue.attr("class") && jvalue.attr("class") == ''){
                            jvalue.removeAttr("class");
                        }
                    });
                    var designerConvXml = (new XMLSerializer()).serializeToString(drawingPanelGenForm[0])
                    designerConvXml = designerConvXml.replace(' class=""', '');
                    designerConvXml = designerConvXml.replace(' xmlns="http://www.w3.org/1999/xhtml"', '');
					$("#generatedCodeTextArea").val(vkbeautify.xml(designerConvXml));
				});

                $("#insertTableBtn").click(function(){
                    var insertTableRowNum = $("#insertTableRowNum").val();
                    var insertTableColNum = $("#insertTableColNum").val();
                    if ($.isNumeric(insertTableRowNum) && $.isNumeric(insertTableColNum) && insertTableRowNum>0 && insertTableColNum>0 ){
                        var id = drawingPanel.getNextId();
                        var insertStr = "<table " + "id='" + id + "'" +  " >";
                        for (i=0; i<insertTableRowNum; i++){
                            insertStr = insertStr + "<tr>";
                            for (j=0; j<insertTableColNum; j++){
                                insertStr = insertStr + "<td>";
                                insertStr = insertStr + "</td>";
                            }                            
                            insertStr = insertStr + "</tr>";
                        }
                        insertStr = insertStr + "</table>"; 
                        $(insertStr).appendTo(drawingPanel);
                        $("#"+id + " td").sortable({
                            helper: 'clone',
                            containment: "#drawingPanelContainer",
                            connectWith: "#drawingPanel td, #drawingPanel, #drawingPanel div.hbox, #drawingPanel div.vbox"
                        });
                        refresh();
                    } else {
                        alert("Invalid value of Rows and Colums");
                    }
                });

                $("#vbox").draggable({
                    helper: function(){
                        var container;
                        var vbox;
                        container = $("<div style='width:auto;height:auto'></div>");
                        vbox = $("<div class='vbox'></div>").sortable({
                            containment: "#drawingPanelContainer",
                            connectWith: "#drawingPanel, #drawingPanel td, #drawingPanel .vbox, #drawingPanel .hbox"
                        });
                        return container.append(vbox);
                    },
                    connectToSortable: "#drawingPanel"
                });

                $("#hbox").draggable({
                    helper: function(){
                        var container;
                        var hbox;
                        container = $("<div style='width:auto;height:auto'></div>");
                        hbox = $("<div class='hbox' ></div>").sortable({
                            containment: "#drawingPanelContainer",
                            connectWith: "#drawingPanel, #drawingPanel td, #drawingPanel div.vbox, #drawingPanel div.hbox"
                        }); 
                        return container.append(hbox);
                    },
                    connectToSortable: "#drawingPanel"
                });

                $("#label").draggable({
                    helper: function(){
                        var label = $("<div id='"+drawingPanel.getNextId()+"' class='control-container control-type-label'><div class='handle'></div><div class='control-content'>label</div></div>") 
                        return label;
                    },
                    connectToSortable: "#drawingPanel"
                });

                $("#input").draggable({
                    helper: function(){
                        var input = $("<div class='input'><input/></div>");
                        return input;
                    },
                    connectToSortable: "#drawingPanel"
                });
                
			});
		</script>
	</head>
	<body>
		<h1>IT Tech Office - Simple Form Designer v0.0.5</h1>
		<table border="1">
            <tr>
                <td colspan="3">
                    Rows: <input id="insertTableRowNum" style="width: 30px" value="2"/>
                    Cols: <input id="insertTableColNum" style="width: 30px" value="2"/>
                    <button id="insertTableBtn" type="button">Insert Table</button>
                </td>
            </tr>
			<tr>
				<td style="vertical-align:top">
					<div id="elementList">
						<div id="vbox"">vbox</div>
						<div id="hbox">hbox</div>
						<div id="label">Label</div>
                        <div id="input">Input</div>
                        <div id="date">Date</div>
                        <div id="datetime">DateTime</div>
                        <div id="checkbox">Checkbox</div>
                        <div id="radio">Radio</div>
                        <div id="textarea">Textarea</div>
					</div>
				</td>
				<td>
                    <div id="drawingPanelContainer">
                        <div id="drawingPanel" style="width:700px;height:500px;background-color:snow"></div>
                    </div>
				</td>
				<td style="vertical-align:top">
					<div id="controlAttrContainer">
                        <table>
                            <tr>
                                <td colspan="2"><b>Attribute</b></td>
                            </tr>
                            <tr>
                                <td><div id="controlIdLabel">ID:</td>
                                <td><input id="controlId"/></td>
                            </tr>
                            <tr>
                                <td><div id="controlTypeLabel">Type:</div></td>
                                <td><input id="controlType"/></td>
                            </tr>
                            <tr>
                                <td><div id="controlValueLabel">Value:</div></td>
                                <td><input id="controlValue"/></td>
                            </tr>
                            <tr>
                                <td colspan="2"><button id="updateDrawingBtn" type="button">Update</button></td>
                            </tr>
                        </table>
					</div>
				</td>
			</tr>
		</table>
		<div>
			<div>
				<button id="generateBtn" type="button">Generate</button>
			</div>
			<div>
				<textarea id="drawingPanelMeta" rows="3" cols="100"></textarea>
			</div>
			<div>
				<textarea id="generatedCodeTextArea" rows="30" cols="100"></textarea>
			</div>
		</div>
	</body>
</html>
